var form_blocked = false;

var translate = function (jsdata)
{	
	$("[tkey]").each (function (index)
	{
		var strTr = jsdata [$(this).attr ('tkey')];
	    $(this).html (strTr);
	});
}

function removeGetParamsFromUrl() {
	var url = '/';
	var curLoc = window.location;
	var curLocHash = curLoc.hash;
	history.pushState(null, null, url+curLocHash);
}

function clearFormErrors() {
	$('.b-contacts__form__field__text_error').removeClass('b-contacts__form__field__text_error').val('');
	$('.b-contacts__form__field__input_error').removeClass('b-contacts__form__field__input_error').val('');
}

function changeLang(locale) {
	clearFormErrors();
	$.getJSON('lang/'+locale+'.json?201902151343', translate);
	if (locale == 'ru')
	{
		$('.b-app').removeClass('b-app_en');
		$('.b-head__menu__language__current').animate( { 'left':'0' }, 150, function() { 
			$('.b-head__menu__language').removeClass('b-head__menu__language_eng').addClass('b-head__menu__language_rus')});
	}
	else if (locale == 'en') {
		$('.b-app').addClass('b-app_en');
		$('.b-head__menu__language__current').animate( { 'left':'57px' }, 150, function() { 
			$('.b-head__menu__language').removeClass('b-head__menu__language_rus').addClass('b-head__menu__language_eng')});
	}
}


$( function() {

	$('.b-curtains').curtain({
		scrollSpeed: 666,
		curtainLinks: '.js-menu-link',
		enableKeys: false,
		nextSlide: function(){
		}
	});
   
	if (lang == 'en') {
		changeLang('en');
	}

	$('.b-head__menu__language__item_eng').click( function() {
		changeLang('en');
	
	});

	$('.b-head__menu__language__item_rus').click( function() {
		removeGetParamsFromUrl();
		changeLang('ru');
	});

	$('.b-head__menu-ctrl').click( function() {
		$(this).hide();
		$('.b-head').addClass('b-head_menu');
		$('.b-head__menu-i').show();
		$('.b-cover').removeClass('g-hidden').show().addClass('b-cover_menu');
		$('.b-head__menu-close').show();
		$('.b-head__menu__language').show();
	});
	
	$('.b-head__menu-close').click( function() {
		$(this).hide();
		$('.b-head').removeClass('b-head_menu');
		$('.b-head__menu-i').hide();
		$('.b-cover').hide().removeClass('b-cover_menu');
		$('.b-head__menu-ctrl').show();
	});
	
	$('.b-about__vacancies__more-i').click( function(e) {
		$(this).hide();
		e.preventDefault()
		$('.b-about__vacancies__list_all').slideDown();
	});
	
	$('.b-contacts__form__field__input').focus( function() { 
		if ( $(this).hasClass('b-contacts__form__field__input_error')) {
			$('.b-contacts__form__field__input_error').removeClass('b-contacts__form__field__input_error').val('');
			$('.b-contacts__form__field__text_error').removeClass('b-contacts__form__field__text_error').val('');
			
		}
	});

	$('.b-contacts__form__field__text').focus( function() { 
		if ( $(this).hasClass('b-contacts__form__field__text_error')) {
			$('.b-contacts__form__field__text_error').removeClass('b-contacts__form__field__text_error').val('');
			$('.b-contacts__form__field__input_error').removeClass('b-contacts__form__field__input_error').val('');
			
		}
	});

	$('.b-popup__close').click( function() {
        $('.b-cover').fadeOut(300, function(){ $(this).show().addClass('g-hidden')});
        $('.b-popup').fadeOut(300, function(){ $(this).show().addClass('g-hidden')});
        return false;
	});
	
	$("#form_tel").mask("+7 (999) 999-99-99");
	
	$("#contact_form").submit(function () {
	    if (form_blocked) {
	        return false;
	    }
	    
	    var form_name = $("#form_name").val();
	    if (form_name.length == 0 && $('.b-head__menu__language').hasClass('b-head__menu__language_rus')) {
	    	$("#form_name").addClass('b-contacts__form__field__input_error').val('Укажите ваше имя');
	    }
	    if (form_name.length == 0 && $('.b-head__menu__language').hasClass('b-head__menu__language_eng')) {
	    	$("#form_name").addClass('b-contacts__form__field__input_error').val('Enter your name');
	    }
	    
	    var form_text = $("#form_text").val();
	    
	    if (form_text.length == 0 && $('.b-head__menu__language').hasClass('b-head__menu__language_rus')) {
	        $("#form_text").addClass('b-contacts__form__field__text_error').val('Введите текст сообщения');
	    }
	    if (form_text.length == 0 && $('.b-head__menu__language').hasClass('b-head__menu__language_eng')) {
	        $("#form_text").addClass('b-contacts__form__field__text_error').val('Enter your message');
	    }
	    
	    var form_tel = $("#form_tel").val();
	    var form_email = $("#form_email").val();
	    
	    if (form_email.length == 0 && $('.b-head__menu__language').hasClass('b-head__menu__language_rus')) {
	        $("#form_email").addClass('b-contacts__form__field__input_error').val('Укажите ваш E-Mail');
	    }
	    if (form_email.length == 0 && $('.b-head__menu__language').hasClass('b-head__menu__language_eng')) {
	        $("#form_email").addClass('b-contacts__form__field__input_error').val('Enter your E-Mail');
	    }
	    
			    
	    if ( $('#form_name').hasClass('b-contacts__form__field__input_error') || $('#form_text').hasClass('b-contacts__form__field__text_error') || $('#form_email').hasClass('b-contacts__form__field__input_error') ) {
	    	return false;
	    }

	    var data = {
	        form_name: form_name,
	        form_tel: form_tel,
	        form_email: form_email,
	        form_text: form_text,
	        form_gc
	    };

	    form_blocked = true;
	    var submitText = $("#form_submit").val();
	    if ( $('.b-head__menu__language').hasClass('b-head__menu__language_rus')) {
	    	$("#form_submit").val("Подождите...");
	    }
	    if ( $('.b-head__menu__language').hasClass('b-head__menu__language_eng')) {
	    	$("#form_submit").val("Wait...");
	    }
	    
	    $.post($(this).attr("action"), data, function (data, textStatus, jqXHR) {
	        if (data.status == "success") {
       	
	        	$('.b-cover').removeClass('g-hidden').hide().fadeIn(300);
	            $('.b-popup').removeClass('g-hidden').hide().fadeIn(400);
	            if ( $('.b-head__menu__language').hasClass('b-head__menu__language_rus')) {
	            	$('.b-popup__text').text('Сообщение успешно отправлено!');
	            }
	            if ( $('.b-head__menu__language').hasClass('b-head__menu__language_eng')) {
	            	$('.b-popup__text').text('Message sent successfully!');
	            }
	            
	        } else {
	        	$('.b-cover').removeClass('g-hidden').hide().fadeIn(300);
	            $('.b-popup').removeClass('g-hidden').hide().fadeIn(400);
	            $('.b-popup__text').text(data.message);
	        }
	        form_blocked = false;
	        $("#form_submit").val(submitText);
	        $("#form_name").val('');
	        $("#form_text").val('');
	        $("#form_email").val('');
	        $("#form_tel").val('');
	    
	    }, "json")
	        .fail(function(jqXHR, textStatus, errorThrown) {
	        	$('.b-cover').removeClass('g-hidden').hide().fadeIn(300);
	            $('.b-popup').removeClass('g-hidden').hide().fadeIn(400);
	            if ( $('.b-head__menu__language').hasClass('b-head__menu__language_rus')) {
	            	$('.b-popup__text').text('Произошла ошибка, пожалуйста, попробуйте позже.');
	            }
	            if ( $('.b-head__menu__language').hasClass('b-head__menu__language_eng')) {
	            	$('.b-popup__text').text('An error occurred, please try again later.');
	            }
	            form_blocked = false;
	            $("#form_submit").val(submitText);
	            
	        });

	    return false;
	});
	
});


function init() {
    window.addEventListener('scroll', function(e){
        var distanceY = window.pageYOffset || document.documentElement.scrollTop,
            shrinkOn = 20,
            header = $(".b-head");
        if (distanceY > shrinkOn) {
            header.addClass("b-head_smaller");
        } else {
            if (header.hasClass("b-head_smaller")) {
                header.removeClass("b-head_smaller");
            }
        }
    });
}
window.onload = init();